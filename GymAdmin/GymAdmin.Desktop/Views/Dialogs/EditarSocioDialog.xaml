<UserControl x:Class="GymAdmin.Desktop.Views.Dialogs.EditarSocioDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:viewModels="clr-namespace:GymAdmin.Desktop.ViewModels.Socios"
             xmlns:local="clr-namespace:GymAdmin.Desktop.Views.Dialogs"
             xmlns:fa="http://schemas.awesome.incremented/wpf/xaml/fontawesome.sharp"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <Border Background="{StaticResource BackgroundWhiteBrush}"
          CornerRadius="10" Padding="18"
          BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
          Width="820" MaxHeight="700">

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,12">
                <TextBlock Text="Editar socio" FontSize="18" FontWeight="Bold"/>

                <!-- Banner de error -->
                <Border Background="#FFfdecea"
                    BorderBrush="#FFf5c2c7"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="8"
                    Margin="0,8,0,0"
                    Visibility="{Binding ErrorMessage, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                    <DockPanel LastChildFill="True">
                        <TextBlock Text="{Binding ErrorMessage}"
                                   Foreground="#FF58151c"
                                   TextWrapping="Wrap" />
                        <Button Content="✕"
                                DockPanel.Dock="Right"
                                Margin="6,0,0,0"
                                Padding="6,0"
                                Width="32"
                                Style="{StaticResource DangerButtonStyle}"    
                                Command="{Binding ClearErrorCommand}"/>
                    </DockPanel>
                </Border>
            </StackPanel>

            <!-- CONTENIDO: grid de 2 columnas -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- IZQUIERDA con scroll propio -->
                <ScrollViewer Grid.Column="0"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      CanContentScroll="True"
                      Margin="0,0,12,0">
                    <StackPanel>
                        <TextBlock Text="DNI" Style="{StaticResource LabelMuted}"/>
                        <TextBox  x:Name="DniTextBox"
                                  Text="{Binding Dni}"
                                  MaxLength="8"
                                  PreviewTextInput="TextBox_PreviewTextInput"
                                  DataObject.Pasting="TextBox_Pasting"/>

                        <TextBlock Text="Nombre" Style="{StaticResource LabelMuted}" Margin="0,6,0,0"/>
                        <TextBox Text="{Binding Nombre}"
                                 PreviewTextInput="NombreTextBox_PreviewTextInput"/>

                        <TextBlock Text="Apellido" Style="{StaticResource LabelMuted}" Margin="0,6,0,0"/>
                        <TextBox Text="{Binding Apellido}"
                                 PreviewTextInput="NombreTextBox_PreviewTextInput"/>

                        <!-- Estado + Créditos -->
                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Estado" Style="{StaticResource LabelMuted}"/>
                                <TextBlock Text="{Binding Estado}"
                           FontWeight="SemiBold"
                           Foreground="{Binding Estado, Converter={StaticResource StatusToColorConverter}}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                <TextBlock Text="Créditos restantes" Style="{StaticResource LabelMuted}"/>
                                <TextBlock Text="{Binding CreditosRestantes}" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Total créditos comprados" Style="{StaticResource LabelMuted}" Margin="0,10,0,0"/>
                        <TextBlock Text="{Binding TotalCreditosComprados}" FontWeight="SemiBold"/>

                        <TextBlock Text="Vigencia" Style="{StaticResource LabelMuted}" Margin="0,10,0,0"/>
                        <TextBlock Text="{Binding VigenciaTexto}" />

                        <TextBlock Text="Último pago" Style="{StaticResource LabelMuted}" Margin="0,10,0,0"/>
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding UltimoPagoTexto}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding UltimoPagoTexto}" Value="{x:Null}">
                                            <Setter Property="Text" Value="—"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding UltimoPagoTexto}" Value="">
                                            <Setter Property="Text" Value="—"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </ScrollViewer>

                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DockPanel Grid.Row="0" Margin="0,0,0,8">
                        <TextBlock Text="Asistencias" FontWeight="Bold" FontSize="18" VerticalAlignment="Center"/>
                        <Button Width="150" DockPanel.Dock="Right" Content="Nueva asistencia"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Command="{Binding NuevaAsistenciaCommand}" Height="35"/>
                    </DockPanel>

                    <DataGrid Grid.Row="1"
                    ItemsSource="{Binding Asistencias}"
                    IsReadOnly="True"
                    Style="{StaticResource BaseDataGridStyle}"
                    AutoGenerateColumns="False"
                    Margin="0,0,0,8"
                    RowHeight="28"
                    EnableRowVirtualization="True"
                    VirtualizingPanel.IsVirtualizing="True"
                    VirtualizingPanel.ScrollUnit="Item"
                    ScrollViewer.CanContentScroll="True"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    MaxHeight="440">
                        <!-- opcional: techo duro -->
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Entrada"
                                  Binding="{Binding EntradaLocal, StringFormat={}{0:dd/MM/yyyy HH:mm}}"
                                  Width="120">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock" BasedOn="{StaticResource CenteredCellText}" />
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Header="Observaciones" Binding="{Binding Observaciones}" Width="*">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock" BasedOn="{StaticResource CenteredCellText}" />
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTemplateColumn Header="ACCIONES" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <Button Style="{StaticResource DataGridActionButtonStyle}"
                              Command="{Binding DataContext.EditarAsistenciaCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                              CommandParameter="{Binding}" ToolTip="Editar asistencia">
                                                <fa:IconImage Icon="Edit" Width="16" Height="16"/>
                                            </Button>
                                            <Button Style="{StaticResource DataGridActionButtonStyle}"
                              Command="{Binding DataContext.EliminarAsistenciaCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                              CommandParameter="{Binding}" ToolTip="Eliminar">
                                                <fa:IconImage Icon="TrashAlt" Width="16" Height="16" Foreground="{StaticResource ErrorBrush}"/>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Paginación -->
                    <Border Grid.Row="2" Background="{StaticResource BackgroundLightBrush}" Padding="10" CornerRadius="4" Margin="0,8,0,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock HorizontalAlignment="Right" Grid.Row="0"
                         Foreground="{StaticResource TextSecondaryBrush}">
                <Run Text="Mostrando "/>
                <Run Text="{Binding DisplayFrom, Mode=OneWay}"/>
                <Run Text=" – "/>
                <Run Text="{Binding DisplayTo, Mode=OneWay}"/>
                <Run Text=" de "/>
                <Run Text="{Binding TotalCount, Mode=OneWay}"/>
                            </TextBlock>

                            <WrapPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                <ComboBox Width="90"
                          ItemsSource="{Binding PageSizes, Mode=OneWay}"
                          SelectedItem="{Binding PageSize}"
                          Style="{StaticResource FilterComboBoxStyle}"
                          ToolTip="Elementos por página" Height="32" Margin="0,0,6,0"/>
                                <Button Content="⏮" Command="{Binding GoFirstPageCommand}" Width="36" Height="32" Margin="0,0,4,0"/>
                                <Button Content="◀"  Command="{Binding GoPrevPageCommand}"  Width="36" Height="32" Margin="0,0,8,0"/>
                                <TextBlock VerticalAlignment="Center" Margin="6,0">
                  <Run Text="Pág. "/>
                  <Run Text="{Binding PageNumber, Mode=OneWay}"/>
                  <Run Text=" / "/>
                  <Run Text="{Binding TotalPages, Mode=OneWay}"/>
                                </TextBlock>
                                <Button Content="▶"  Command="{Binding GoNextPageCommand}"  Width="36" Height="32" Margin="8,0,4,0"/>
                                <Button Content="⏭" Command="{Binding GoLastPageCommand}" Width="36" Height="32"/>
                            </WrapPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- Footer -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                <Button Content="Cancelar" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding CancelarCommand}"/>
                <Button Content="Guardar"  Style="{StaticResource PrimaryButtonStyle}"   Command="{Binding GuardarCommand}"/>
            </StackPanel>

            <Grid Grid.RowSpan="3"
                  Visibility="{Binding IsInnerDialogOpen, Converter={StaticResource BoolToVisibilityConverter}}"
                  Background="#80000000"
                  Panel.ZIndex="1000"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  IsHitTestVisible="True" 
                  KeyboardNavigation.TabNavigation="Cycle"
                  KeyboardNavigation.ControlTabNavigation="Cycle">
                <ContentControl Content="{Binding InnerDialogContent}"
                    HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Grid>
        </Grid>
    </Border>
</UserControl>